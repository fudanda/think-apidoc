{extend name="index" /}
{block name="head"}

{/block}


{block name='content'}
<div class="layui-card" id="view_title"></div>
<div class="layui-card" id="view_interface">
    <fieldset class="layui-elem-field">
        <legend>接口信息/调试</legend>
        <div class="layui-field-box">
            <div class="layui-tab layui-tab-card">
                <ul class="layui-tab-title">
                    <ul class="layui-tab-title">
                        <li class="layui-this" lay-id="detail">接口详情</li>
                        <li lay-id="debug">在线调试</li>
                    </ul>
                </ul>
                <div class="layui-tab-content">
                    <div class="layui-tab-item layui-show">
                        <div id="view_detail"></div>
                    </div>
                    <div class="layui-tab-item">
                        <div id="view_bug"></div>
                    </div>
                </div>
            </div>
        </div>
    </fieldset>
</div>
<div class="layui-card" id="view_directory">

</div>
<div style="padding-bottom: 15px;" id="view_log">

</div>
<div id="view_prompt">
    <fieldset class="layui-elem-field">
        <legend>温馨提示</legend>
        <div class="layui-field-box">
            <blockquote class="layui-elem-quote">此文档是由系统自动生成，如发现错误或疑问请告知开发人员及时修改</blockquote>
        </div>
    </fieldset>
</div>
<script type="text/html" id="title">
    <fieldset class="layui-elem-field">
        <legend>{{ d.ApiTitle }}</legend>
        <div class="layui-field-box">
            <p><span>说明</span>：{{ d.ApiDesc}}</p>
        </div>
    </fieldset>
</script>
<script type="text/html" id="detail">
    <table class="layui-table">
        <colgroup>
            <col width="100">
            <col>
        </colgroup>
        <tbody>
            <tr>
                <td>接口地址</td>
                <td>
                    <a target="_blank" href="{{ d.ApiUrl }}">
                        {{ d.ApiUrl }}
                    </a>
                </td>
            </tr>
            <tr>
                <td>请求方式</td>
                <td>{{ method(d.ApiMethod) }}</td>
            </tr>
            <tr>
                <td>接口版本</td>
                <td>{{ d.ApiVersion ? d.ApiVersion : '-' }}</td>
            </tr>
            <tr>
                <td>开发人员</td>
                <td>{{ d.ApiAuthor ? d.ApiAuthor : '-' }}</td>
            </tr>
            {{# if(d.ApiParam){ }}
            <tr>
                <td>请求参数</td>
                <td>
                    <table class="layui-table">
                        <colgroup>
                            <col width="100">
                            <col>
                        </colgroup>
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th style="max-width:300px;">默认值</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{# layui.each(d.ApiParam,function(k,v){ }}
                            <tr class="{{#  if((v.name).substr(0, 1)=="#"){ }}layui-bg-blue{{#  } }} ">
                                <td>{{ v.name }}</td>
                                <td><span class="layui-badge layui-bg-green">{{ v.type }}</span></td>
                                <td style="max-width:300px; word-wrap: break-word;word-break: normal;">{{ v.default }}
                                </td>
                                <td>{{ v.desc }}</td>
                            </tr>
                            {{# }); }}
                        </tbody>
                    </table>
                </td>
            </tr>
            {{# } }}
            {{# if(d.ApiReturn){ }}
            <tr>
                <td>响应参数</td>
                <td>
                    <table class="layui-table">
                        <colgroup>
                            <col width="100">
                            <col>
                        </colgroup>
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>类型</th>
                                <th>默认值</th>
                                <th>说明</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{# layui.each(d.ApiReturn,function(k,v){ }}
                            <tr class="{{#  if((v.name).substr(0, 1)=="#"){ }}layui-bg-blue{{#  } }} ">
                                <td>{{ v.name }}</td>
                                <td><span class="layui-badge layui-bg-green">{{ v.type }}</span></td>
                                <td>{{ v.default }}</td>
                                <td>{{ v.desc }}</td>
                            </tr>
                            {{# }); }}
                        </tbody>
                    </table>
                </td>
            </tr>
            {{# } }}
        </tbody>
    </table>
</script>
<script type="text/html" id="directory">
    <div class="layui-layer layui-layer-page layui-layer-dir" id="layui-layer1" type="page" times="1" showtime="0"
        contype="object" style="z-index: 19891015; top: 365px; left: 1313px; margin-left: -15px;">
        <div class="layui-layer-title" style="cursor: move;">目录</div>
        <div id="" class="layui-layer-content">
            <ul class="site-dir layui-layer-wrap" style="display: block;">
                <li><a href="#view_title"><cite>{{ d.ApiTitle }}</cite></a></li>
                <li><a href="#view_interface"><cite>接口信息/调试</cite></a></li>
                <li><a href="#view_log"><cite>日志</cite></a></li>
                <li><a href="#view_prompt"><cite>温馨提示</cite></a></li>
            </ul>
            <!-- </div><span class="layui-layer-setwin"><a class="layui-layer-ico layui-layer-close layui-layer-close1"
                href="javascript:;"></a></span><span class="layui-layer-resize"></span> -->
        </div>
</script>
<script type="text/html" id="bug">
    <form class="layui-form">
        <div class="layui-form-item">
            <label class="layui-form-label">接口地址</label>
            <div class="layui-input-block">
                <input type="url" name="url" required lay-verify="url" placeholder="请输入接口地址" autocomplete="off"
                    class="layui-input" value="{{ d.ApiUrl ? d.ApiUrl : ''}}">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">请求方式</label>
            <div class="layui-input-inline">
                <select name="method" lay-verify="required">
                    {{# layui.each(['GET','POST','PUT','DELETE'],function(index,item){ }}
                    <option value="{{ item }}" {{# if(item.trim()== d.ApiMethod.trim()){ }}selected{{# } }}>{{ item }}
                    </option>
                    {{# }); }}
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">请求头部</label>
            <div class="layui-input-block">
                <table class="layui-table">
                    <colgroup>
                        <col width="100">
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th>参数</th>
                            <th>参数值</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{# if(d.is_header == 1){ }}
                        {{# layui.each(d._header,function(index,item){ }}
                        <tr>
                            <td><input name="header[name][]" type="text" disabled class="layui-input"
                                    value="{{ index }}">
                            </td>
                            <td><input name="header[value][]" type="text" class="layui-input" value="{{ item }}"></td>
                            <th>
                                <button class="layui-btn layui-btn-danger layui-btn-xs" type="button" data-type="del">删除
                                </button>
                            </th>
                        </tr>
                        {{# }); }}
                        {{# }; }}
                    </tbody>
                </table>
                <div style="text-align: center;">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" data-type="add" data-field="header"
                        type="button">添加一行
                    </button>
                </div>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">请求参数</label>
            <div class="layui-input-block">
                <table class="layui-table">
                    <colgroup>
                        <col width="200">
                        <col>
                    </colgroup>
                    <thead>
                        <tr>
                            <th>参数</th>
                            <th>参数值</th>
                            <th>类型</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{# if(d.is_params == 1){ }}
                        {{# layui.each(d._params,function(index,item){ }}
                        <tr>
                            <td><input name="params[name][]" type="text" disabled class="layui-input"
                                    value="{{ index }}">
                            </td>
                            <td><input name="params[value][]" type="text" class="layui-input" value="{{ item }}"></td>
                            <th>
                                <button class="layui-btn layui-btn-danger layui-btn-xs" type="button" data-type="del">删除
                                </button>
                            </th>
                        </tr>
                        {{# }); }}
                        {{# }; }}
                        {{# if(d.ApiParam){ }}
                        {{# layui.each(d.ApiParam,function(index,item){ }}
                        <tr>
                            <td><input name="params[name][]" type="text" class="layui-input" value='{{ item.name}}'>
                            </td>
                            <td><input name="params[value][]" type="text" class="layui-input"
                                    value='{{ item.default }}'></td>
                            <td><input name="params[type][]" type="text" class="layui-input" value='{{ item.type }}'>
                            </td>
                            <td>
                                <button class="layui-btn layui-btn-danger layui-btn-xs" type="button" data-type="del">删除
                                </button>
                            </td>
                        </tr>
                        {{# }); }}
                        {{# } }}
                    </tbody>
                </table>
                <div style="text-align: center;">
                    <button class="layui-btn layui-btn-normal layui-btn-sm" type="button" data-type="add"
                        data-field="params">添加一行
                    </button>
                </div>
            </div>
        </div>
        <input type="hidden" name="cookie" value="{:http_build_query($_COOKIE,'',';')}">

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="debug">立即提交</button>
                <button type="reset" class="layui-btn layui-btn-primary">重置</button>
            </div>
        </div>
    </form>
</script>
<script type="text/html" id="log">
    <fieldset class="layui-elem-field">
        <legend>更新日志</legend>
        <div class="layui-field-box">
            {{# if(d.ApiLog){ }}
            <ul class="layui-timeline">
                {{# layui.each(d.ApiLog,function(k,v){ }}
                <li class="layui-timeline-item">
                    <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                    <div class="layui-timeline-content layui-text">
                        <h3 class="layui-timeline-title"> {{ v.title }}</h3>
                        <p>
                            {{ v.desc }}
                        </p>
                    </div>
                </li>
                {{# }); }}
            </ul>
            {{#  } else { }}
            暂无
            {{#  } }}
        </div>
    </fieldset>
</script>



{/block}

{block name='js'}
<script>
    layui.use(['laytpl', 'jquery'], function () {
        var laytpl = layui.laytpl,
            $ = layui.jquery;
        $.get(window.location.href, function (response) {
            if (response.code == 0) {
                render(title.innerHTML, 'view_title', response.data);
                render(detail.innerHTML, 'view_detail', response.data);
                render(bug.innerHTML, 'view_bug', response.data);
                render(log.innerHTML, 'view_log', response.data);
                render(directory.innerHTML, 'view_directory', response.data);
            }
        });

        function render(tpl, _view, data) {
            var view = document.getElementById(_view);
            laytpl(tpl).render(data, function (html) {
                view.innerHTML = html;
            })
        }

        var action = {
            add: function () {
                var field = this.data('field')
                this.parents('.layui-input-block').find('table tbody').append("<tr>\n" +
                    "                        <td><input name='" + field +
                    "[name][]' type=\"text\" class=\"layui-input\" value=''></td>\n" +
                    "                        <td><input name='" + field +
                    "[value][]' type=\"text\" class=\"layui-input\" value=''></td>\n" +
                    "                        <td>\n" +
                    "                            <button class=\"layui-btn layui-btn-danger layui-btn-xs\"\n" +
                    "                                    data-type=\"del\" \n" +
                    "                                    type=\"button\">删除\n" +
                    "                            </button>\n" +
                    "                        </td>\n" +
                    "                    </tr>");
            },
            del: function () {
                this.parents('tr').remove();
            }
        }

        $('body').delegate('button', 'click', function () {
            var type = $(this).data('type');
            action[type] && action[type].call($(this));
        });
        // 格式化对象输出
        function writeHtml(obj) {
            var objStr = JSON.stringify(obj, null, 4);
            var html = objStr.replace(/\n/g, '<br>').replace(/\s/g, '&nbsp');
            return html
        }
        //请求方式加颜色
        window.method = function (param) {
            var method = {
                'GET': 'class="layui-badge layui-bg-green"',
                'POST': 'class="layui-badge layui-bg-blue"',
                'PUT': 'class="layui-badge layui-bg-orange"',
                'DELETE': 'class="layui-badge"',
            };
            if (!method[param]) {
                return '-';
            }
            return '<span ' + method[param] + '>' + param + '</span>';
        }
        layui.use(['form', 'layer'], function () {
            var form = layui.form,
                layer = layui.layer;

            form.on('submit(debug)', function (data) {
                var index = layer.load(0, {
                    shade: false
                }); //0代表加载的风格，支持0-2
                $.ajax({
                    url: "/doc/format_params",
                    type: 'POST',
                    data: data.field,
                    success: function (response) {
                        var token = localStorage.getItem('token');
                        if (token != null) {
                            response.params['token'] = token;
                        }
                        $.ajax({
                            url: data.field.url,
                            type: data.field.method,
                            // headers: response.header,
                            data: response.params,
                            complete: function (XHR) {
                                layer.close(index);
                                var html = "";
                                if (XHR.readyState == 4 && XHR.status ==
                                    200) {
                                    var result = XHR.responseJSON;
                                    if (result.hasOwnProperty(
                                            'token')) {
                                        localStorage.setItem('token',
                                            result.token);
                                    }
                                    html =
                                        "<pre class='layui-code' lay-skin='notepad' lay-encode='true' style='margin: 0'>" +
                                        writeHtml(result) + "</pre>";
                                } else {
                                    html = XHR.responseText;
                                }
                                var w = '';
                                var h = '';
                                if (w == null || w == '') {
                                    w = ($(window).width() * 0.75);
                                };
                                if (h == null || h == '') {
                                    h = ($(window).height() - 100);
                                };
                                layer.open({
                                    type: 1,
                                    area: [w + 'px', h + 'px'],
                                    fix: false, //不固定
                                    maxmin: true,
                                    shadeClose: true,
                                    shade: 0.4,
                                    title: 'title',
                                    content: html,
                                });
                            }
                        })

                    }
                });
                return false;
            })
        })
    });
</script>
{/block}